name: Auto-Updater Bot

on:
  # 1. Ø§Ø¬Ø±Ø§ Ø·Ø¨Ù‚ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø²Ù…Ø§Ù†ÛŒ (Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 00:00 Ø¨Ù‡ ÙˆÙ‚Øª Ø¬Ù‡Ø§Ù†ÛŒ)
  schedule:
    - cron: '0 0 * * *'
  # 2. Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Ù…Ø±Ø­Ù„Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯: Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ù¾Ø¯ÛŒØª ---
      - name: Check for Updates
        id: check
        run: |
          # 1. Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† ØªÚ¯ Ø§Ø² Ù…Ø®Ø²Ù† Ø§ØµÙ„ÛŒ (Ø³Ø§Ø²Ù†Ø¯Ù‡ xray-knife)
          UPSTREAM_TAG=$(curl -s https://api.github.com/repos/lilendian0x00/xray-knife/releases/latest | jq -r .tag_name)
          echo "Latest Upstream Version: $UPSTREAM_TAG"
          
          # 2. Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø±Ø§ Ø±ÛŒÙ„ÛŒØ² Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒÙ…ØŸ
          # Ù…Ø§ Ø§Ø² API Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ø®ÙˆØ¯Ù…Ø§Ù† Ø³ÙˆØ§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/tags/$UPSTREAM_TAG)
          
          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "âœ… We already have version $UPSTREAM_TAG. Skipping build."
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
          else
            echo "ğŸš€ New version found ($UPSTREAM_TAG)! Starting build..."
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            echo "VERSION_TAG=$UPSTREAM_TAG" >> $GITHUB_ENV
          fi

      # --- Ù…Ø±Ø§Ø­Ù„ Ø²ÛŒØ± ÙÙ‚Ø· Ø§Ú¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ ---
      
      - name: Setup Java
        if: env.UPDATE_NEEDED == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        if: env.UPDATE_NEEDED == 'true'
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Download Xray Core (Specific Version)
        if: env.UPDATE_NEEDED == 'true'
        run: |
          mkdir -p assets
          # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø³Ø®Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡
          wget -O xray.zip https://github.com/lilendian0x00/xray-knife/releases/download/${{ env.VERSION_TAG }}/Xray-knife-android-arm64-v8a.zip
          unzip -o xray.zip
          mv xray-knife assets/xray-knife
          chmod +x assets/xray-knife

      - name: Get Dependencies
        if: env.UPDATE_NEEDED == 'true'
        run: flutter pub get

      - name: Build APK
        if: env.UPDATE_NEEDED == 'true'
        run: flutter build apk --release --no-tree-shake-icons

      - name: Sign APK
        if: env.UPDATE_NEEDED == 'true'
        run: |
          keytool -genkey -v -keystore release.jks -keyalg RSA -keysize 2048 -validity 10000 -alias my-alias -storepass 123456 -keypass 123456 -dname "CN=XrayManager, OU=App, O=GitHub, L=Internet, C=US"
          
          ANDROID_BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools/ | sort -V | tail -n 1)
          APKSIGNER=$ANDROID_HOME/build-tools/$ANDROID_BUILD_TOOLS_VERSION/apksigner
          
          $APKSIGNER sign --ks release.jks --ks-pass pass:123456 --out signed-app.apk build/app/outputs/flutter-apk/app-release.apk

      - name: Publish Release Automatically
        if: env.UPDATE_NEEDED == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: Xray-Knife ${{ env.VERSION_TAG }}
          files: signed-app.apk
          body: |
            Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ Ù†Ø³Ø®Ù‡ ${{ env.VERSION_TAG }}
            Ù‡Ø³ØªÙ‡ Ø§ØµÙ„ÛŒ: xray-knife ${{ env.VERSION_TAG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
